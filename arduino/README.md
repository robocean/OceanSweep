# ⚙️ Arduino Module

> 센서 측정값 획득, 전처리 및 데이터 가공

*(본 README.md 파일은 Arduino 모듈의 세부 사항을 포함하며, 전체 프로젝트 개요는 [여기](../README.md)에서 확인할 수 있다.)*

---

## 📌 모듈 개요

`Arduino Module`은 'OceanSweep' 로봇 시스템 내에서 **핵심 센서 데이터의 획득 및 전처리 역할**을 담당한다. 본 모듈은 IMU(Inertial Measurement Unit) 및 GPS 센서로부터 측정값을 실시간으로 수신하며, 수신된 데이터에 필터링 및 가공 알고리즘을 적용하여 노이즈를 제거하고 가시성 높은 형태로 변환한다. 가공된 데이터는 시리얼 통신을 통해 상위 제어 모듈로 전달되어 웨이포인트 경로 추정 알고리즘에 활용된다.

## ✨ 주요 기능

* **센서 측정값 획득**: IMU 및 GPS 센서로부터 원시(raw) 측정값을 실시간으로 수신한다.
* **IMU 센서 노이즈 제거 (지수가중이동평균필터)**: IMU 데이터에 포함된 노이즈 제거를 위해 **지수가중이동평균필터(Exponentially Weighted Moving Average Filter)**, 즉 저역 통과 필터(Low-pass Filter)를 적용하여 안정적인 방위각 데이터를 제공한다.
* **Sawtooth 선형화 알고리즘**: IMU Yaw 값에서 발생하는 Sawtooth(톱니파) 현상을 보정하여 연속적이고 선형적인 방위각 데이터를 생성한다. 이는 0도와 360도 경계에서의 불연속성을 해결하여 제어 알고리즘의 안정성을 제고한다.
* **지자기 편각 보정**: 국토지리정보원에서 제공하는 지자기 편각 정보를 활용하여 지자기 센서의 캘리브레이션을 수행한다. 이를 통해 실제 북쪽(True North)에 대한 정확한 방위각을 계산한다.
* **데이터 가공 및 시리얼 통신**: 측정 및 필터링된 데이터를 상위 시스템 활용에 용이한 형태로 가공한 후, 시리얼 통신 프로토콜에 따라 상위 제어 모듈로 안정적으로 전송한다.

## ⚙️ 기술 스택 및 구현 환경

* **플랫폼**: Arduino (마이크로컨트롤러 보드)
* **센서**: IMU 센서, GPS 센서 (Neo-6M GPS 모듈)
* **통신**: 시리얼 통신
* **알고리즘**: 지수가중이동평균필터 (LPF), Sawtooth 선형화 알고리즘, 지자기 편각 보정 로직

## 🛠️ 작동 원리 및 구현 상세

`Arduino Module`은 로봇의 물리 센서와 상위 제어 모듈 간의 인터페이스 역할을 수행한다. 아두이노 보드는 IMU 및 GPS 센서와 직접 연결되어, 각 센서로부터 원시 데이터를 지속적으로 획득한다.

### 지수가중이동평균필터 (Exponentially Weighted Moving Average Filter, LPF)

수신된 IMU 데이터, 특히 Yaw 값에는 환경적 요인에 의한 노이즈가 포함될 수 있다. 이를 해결하기 위해 **지수가중이동평균필터**를 적용하여 데이터 평활화를 수행한다. 본 필터는 현재 측정값에 일정한 가중치($\alpha$)를 곱하고, 이전 추정값과 합산하여 현재 추정값을 계산하는 방식으로 작동한다.

**필터 계산식:**
$x_k = \alpha \cdot x_{k-1} + (1 - \alpha) \cdot z_k$

* $\bar{x}_k$: 현재 추정값
* $\bar{x}_{k-1}$: 이전 추정값
* $\alpha$: 0과 1 사이의 상수 (가중치)
* $x_k$: 현재 측정값

상기 식을 전개하면 이전 측정값들이 현재 추정값에 점진적으로 감소하는 가중치로 반영되는 것을 확인할 수 있다: \

$$
\bar{x}_k = \alpha \cdot (\alpha \cdot \bar{x}_{k-2} + (1 - \alpha) \cdot x_{k-1}) + (1 - \alpha) \cdot x_k
$$

$$
= \alpha^2 \cdot \bar{x}_{k-2} + \alpha(1 - \alpha) \cdot x_{k-1} + (1 - \alpha) \cdot x_k
$$

여기서 가중치 $\alpha$를 조절하여 필터의 특성을 변경할 수 있다. $\alpha$를 낮게 설정하여 현재 측정값($z_k$)에 더 큰 가중치($1 - \alpha$)를 부여하면, 추정값이 현재 상태를 보다 잘 반영한다. 반대로 $\alpha$를 높게 설정하여 현재 측정값에 낮은 가중치를 부여하면, 노이즈 억제 성능이 향상된다.

본 필터는 이전 추정값($x_{k-1}$)만을 저장하면 되므로, 일반적인 이동평균필터에 비해 메모리 사용 측면에서 이점을 제공한다. 또한, $\alpha$ 값을 적절히 조절함으로써 추정값이 현재 상태를 더욱 정확하게 표현할 수 있다는 장점이 있다.

### Sawtooth 선형화 알고리즘

IMU의 방위각 데이터가 0도와 360도 사이를 반복하며 발생하는 Sawtooth 현상은 제어 알고리즘의 오작동을 유발할 수 있다. 예를 들어, 350도에서 10도로 변화 시 실제 회전각은 작으나 데이터상에서는 불연속적인 큰 변화가 발생한다. 이러한 문제를 해결하기 위해 **연속적인 값으로 변환하는 선형화 알고리즘**을 적용한다. 본 알고리즘은 각도가 360도를 초과하거나 0도 미만으로 떨어질 때 적절한 보정을 수행하여 항상 연속적인 값을 유지하도록 한다.

![server_](https://drive.google.com/uc?export=view&id=1KHbmi5AWiP2HyyK3OAYHQdptOB3Dlza1)  
<sub>*sawthooth 보정*</sub>

지자기 센서의 정확도를 제고하기 위해 국토지리정보원의 지자기 편각 정보를 활용하여 센서 캘리브레이션을 진행하며, 이를 통해 실제 북쪽을 기준으로 하는 정확한 방위각을 계산한다.

GPS 센서로부터는 위치 정보를 획득하며, 이 모든 가공된 데이터는 시리얼 통신 프로토콜에 따라 정해진 형태로 포맷팅되어 상위 제어 모듈로 전송된다. 전송된 데이터는 `waypoint` 모듈의 경로 추정 및 제어 알고리즘의 핵심 입력값으로 활용된다.